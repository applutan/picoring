<!DOCTYPE html>
<html>
<head>
    <title>Pico Ring Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; text-align: center; padding: 10px; }
        h1 { margin-bottom: 5px; font-size: 1.5rem; }
        .card { background: #333; padding: 15px; border-radius: 10px; margin: 10px auto; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input[type="range"] { width: 100%; height: 30px; }
        .value-display { font-family: monospace; color: #0ff; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; font-size: 16px; border-radius: 5px; margin: 5px; cursor: pointer; touch-action: manipulation; }
        button:active { background: #0056b3; }
        #pattern-str { font-size: 1rem; letter-spacing: 2px; word-break: break-all; color: #ff0; margin: 10px 0; font-family: monospace; }
        
        /* Visualizer */
        #sim-canvas {
            background: #111;
            border-radius: 50%;
            margin: 10px auto;
            display: block;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Pico Ring</h1>

    <canvas id="sim-canvas" width="280" height="280"></canvas>

    <div class="card">
        <label>Pattern <span id="pat-idx" class="value-display">0</span></label>
        <div id="pattern-str">Loading...</div>
        <div class="control-group">
            <button onclick="changePattern(-1)">&lt;</button>
            <button onclick="toggleRun()">Play/Pause</button>
            <button onclick="changePattern(1)">&gt;</button>
        </div>

        <div class="control-group">
            <label>Align to Color</label>
            <div id="palette-btns" style="display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;">
                <!-- Buttons will be generated by JS to match palette -->
            </div>
        </div>
    </div>

    <div class="card">
        <div class="control-group">
            <label>Brightness: <span id="val-bright" class="value-display">0.2</span></label>
            <input type="range" id="rng-bright" min="0" max="100" value="20" oninput="updateSettings()">
        </div>

        <div class="control-group">
            <label>Rate (sec): <span id="val-rate" class="value-display">0.5</span></label>
            <input type="range" id="rng-rate" min="10" max="2000" value="500" oninput="updateSettings()">
        </div>
    </div>

    <script>
        const PALETTE = [
            [255, 0, 0], [0, 255, 0], [0, 0, 255], [255, 255, 0],
            [255, 0, 255], [0, 255, 255], [255, 128, 0], [255, 255, 255]
        ];

        const canvas = document.getElementById('sim-canvas');
        const ctx = canvas.getContext('2d');
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const radius = 90;
        const ledRadius = 12;

        function drawRing(patternStr, brightness) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw PCB Ring
            ctx.beginPath();
            ctx.arc(cx, cy, radius + ledRadius + 4, 0, Math.PI * 2);
            ctx.fillStyle = "#222";
            ctx.fill();
            ctx.strokeStyle = "#444";
            ctx.lineWidth = 2;
            ctx.stroke();

            for (let i = 0; i < 16; i++) {
                // Go Counter-Clockwise: -i instead of i
                const angle = (-i * (360 / 16)) * (Math.PI / 180) - (Math.PI / 2);
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;

                let colorIdx = parseInt(patternStr[i]);
                if (isNaN(colorIdx)) colorIdx = 0;
                let baseColor = PALETTE[colorIdx] || [0,0,0];
                
                // Simulate Brightness
                let r = Math.floor(baseColor[0] * brightness);
                let g = Math.floor(baseColor[1] * brightness);
                let b = Math.floor(baseColor[2] * brightness);
                
                // Draw LED Glow
                ctx.beginPath();
                ctx.arc(x, y, ledRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fill();
                
                // Draw LED Center
                ctx.beginPath();
                ctx.arc(x, y, ledRadius - 4, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255,255,255,0.4)`;
                ctx.fill();

                // Draw Character from Pattern
                let char = patternStr[i] || "?";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 14px monospace";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(char, x, y);
            }
        }

        function updateUI(data) {
            document.getElementById('pat-idx').innerText = data.idx;
            document.getElementById('pattern-str').innerText = data.disp;
            document.getElementById('val-bright').innerText = data.bri.toFixed(2);
            document.getElementById('val-rate').innerText = data.rate.toFixed(2);
            
            if (document.activeElement.id !== 'rng-bright') 
                document.getElementById('rng-bright').value = data.bri * 100;
            if (document.activeElement.id !== 'rng-rate') 
                document.getElementById('rng-rate').value = data.rate * 1000;

            drawRing(data.disp, data.bri);
        }

        function fetchStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => updateUI(data))
                .catch(err => console.log(err));
        }

        function updateSettings() {
            let bri = document.getElementById('rng-bright').value / 100;
            let rate = document.getElementById('rng-rate').value / 1000;
            
            // Optimistic update
            document.getElementById('val-bright').innerText = bri.toFixed(2);
            document.getElementById('val-rate').innerText = rate.toFixed(2);

            fetch(`/api/set?bri=${bri}&rate=${rate}`);
        }

        function changePattern(dir) {
            fetch(`/api/pattern?dir=${dir}`).then(() => fetchStatus());
        }

        function toggleRun() {
            fetch(`/api/toggle`).then(() => fetchStatus());
        }

        function alignTo(digit) {
            fetch(`/api/align?c=${digit}`).then(() => fetchStatus());
        }

        // Generate Palette Buttons
        const btnContainer = document.getElementById('palette-btns');
        PALETTE.forEach((col, idx) => {
            let btn = document.createElement('button');
            btn.innerText = idx;
            btn.style.backgroundColor = `rgb(${col[0]}, ${col[1]}, ${col[2]})`;
            // Make text black or white depending on brightness for contrast
            let brightness = (col[0] * 299 + col[1] * 587 + col[2] * 114) / 1000;
            btn.style.color = brightness > 128 ? 'black' : 'white';
            btn.style.padding = "10px";
            btn.style.margin = "2px";
            btn.style.minWidth = "30px";
            btn.onclick = () => alignTo(idx);
            btnContainer.appendChild(btn);
        });

        setInterval(fetchStatus, 500); // Poll every 500ms
        fetchStatus();
    </script>
</body>
</html>